name: Build Android APK

on:
  pull_request:
    branches: [main]

env:
  GODOT_VERSION: "4.3"

jobs:
  build-apk:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup export templates
        run: |
          # GitHub Actions sets HOME=/github/home inside containers,
          # but barichello/godot-ci installs templates under /root/.
          # Copy templates to where Godot will actually look for them.
          TEMPLATE_DIR="$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable"
          mkdir -p "$TEMPLATE_DIR"
          cp /root/.local/share/godot/export_templates/${GODOT_VERSION}.stable/* \
             "$TEMPLATE_DIR/" 2>/dev/null || true
          echo "Templates directory contents:"
          ls -la "$TEMPLATE_DIR/" || echo "No templates found!"

      - name: Setup Java SDK
        run: |
          # Find the Java installation path available in the container
          JAVA_HOME_PATH=$(dirname $(dirname $(readlink -f $(which javac 2>/dev/null || which java 2>/dev/null))))
          echo "Detected JAVA_HOME: $JAVA_HOME_PATH"
          echo "JAVA_HOME=$JAVA_HOME_PATH" >> $GITHUB_ENV

      - name: Setup Android SDK and keystore
        run: |
          # Create a debug keystore for CI builds
          mkdir -p "$HOME/.android"
          keytool -genkey -v \
            -keystore "$HOME/.android/debug.keystore" \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US" \
            2>/dev/null

          # Find Android SDK path
          ANDROID_SDK=""
          for path in /usr/lib/android-sdk /opt/android-sdk "$ANDROID_HOME" "$ANDROID_SDK_ROOT"; do
            if [ -d "$path" ]; then
              ANDROID_SDK="$path"
              break
            fi
          done
          echo "Detected Android SDK: $ANDROID_SDK"

          # Configure Godot editor settings for Android export
          mkdir -p "$HOME/.config/godot"
          cat > "$HOME/.config/godot/editor_settings-4.tres" <<EOF
          [gd_resource type="EditorSettings" format=3]

          [resource]
          export/android/android_sdk_path = "$ANDROID_SDK"
          export/android/java_sdk_path = "$JAVA_HOME"
          export/android/debug_keystore = "$HOME/.android/debug.keystore"
          export/android/debug_keystore_user = "androiddebugkey"
          export/android/debug_keystore_pass = "android"
          EOF

          echo "Editor settings:"
          cat "$HOME/.config/godot/editor_settings-4.tres"

      - name: Import project
        run: |
          godot --headless --import 2>&1 || true
          sleep 2

      - name: Create export directory
        run: mkdir -p export

      - name: Build APK
        run: |
          godot --headless --export-debug "Android" export/ai-rpg.apk 2>&1

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-rpg-android
          path: export/ai-rpg.apk
          retention-days: 14
          if-no-files-found: error

      - name: ðŸš€ Generate Fast Download Link
        run: |
          # 1. Install curl (the container is likely Debian/Ubuntu based)
          apt-get update && apt-get install -y curl

          # 2. Upload to 0x0.st
          echo "Uploading..."
          # We capture the output link into a variable to print it clearly
          LINK=$(curl -F "file=@./export/ai-rpg.apk" https://0x0.st)
          
          echo "-------------------------------------------------------"
          echo "DOWNLOAD HERE: $LINK"
          echo "-------------------------------------------------------"
