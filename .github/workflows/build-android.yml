name: Build Android APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Permission needed to create/edit Releases
permissions:
  contents: write

env:
  GODOT_VERSION: "4.3"
  HOME: /root

jobs:
  build-apk:
    runs-on: ubuntu-latest
    container:
      image: barichello/godot-ci:4.3

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Godot Import
        uses: actions/cache@v4
        with:
          path: .godot/imported
          key: godot-import-${{ runner.os }}-${{ hashFiles('project.godot', '**/*.import') }}

      - name: Setup Java SDK
        run: |
          echo "JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))" >> $GITHUB_ENV

      - name: Setup Android Keystore
        run: |
          mkdir -p $HOME/.android
          keytool -genkey -v \
            -keystore $HOME/.android/debug.keystore \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

      - name: Configure Editor Settings
        run: |
          mkdir -p $HOME/.config/godot
          cat > $HOME/.config/godot/editor_settings-4.tres <<EOF
          [gd_resource type="EditorSettings" format=3]
          [resource]
          export/android/android_sdk_path = "$ANDROID_SDK_ROOT"
          export/android/debug_keystore = "$HOME/.android/debug.keystore"
          export/android/debug_keystore_user = "androiddebugkey"
          export/android/debug_keystore_pass = "android"
          EOF

      - name: Import project
        run: godot --headless --import --verbose 2>&1 || true

      - name: Create export directory
        run: mkdir -p export

      - name: Build APK
        run: godot --headless --export-debug "Android" export/ai-rpg.apk 2>&1

      # --- DELIVERY METHODS ---

      # Method A: FAST RELEASE (Use for Main AND PRs)
      # This puts the APK on GitHub Releases (AWS CloudFront CDN) - Maximum Speed.
      - name: Update Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          # If main branch -> tag is 'nightly'
          # If PR -> tag is 'pr-build'
          tag_name: ${{ github.ref == 'refs/heads/main' && 'nightly' || 'pr-build' }}
          name: ${{ github.ref == 'refs/heads/main' && 'Nightly Build' || 'Latest PR Build' }}
          body: |
            Build triggered by: ${{ github.event_name }}
            Ref: ${{ github.ref }}
            Commit: ${{ github.sha }}
          files: export/ai-rpg.apk
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Method B: Standard Artifact (Backup)
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ai-rpg-android
          path: export/ai-rpg.apk
          retention-days: 7
